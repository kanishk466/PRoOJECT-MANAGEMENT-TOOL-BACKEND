generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  MANAGER
  DEVELOPER
  TESTER
}

enum TicketStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  RESOLVED
  CLOSED
  REOPENED
}

enum Priority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

model User {
  id           Int     @id @default(autoincrement())
  email        String  @unique
  passwordHash String
  name         String
  role         Role
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdTickets  Ticket[]        @relation("CreatedTickets")
  assignedTickets Ticket[]        @relation("AssignedTickets")
  histories       TicketHistory[]
  comments        Comment[]
  attachments     Attachment[]
  createdSprints  Sprint[]        @relation("SprintCreator")
}

model Ticket {
  id           Int          @id @default(autoincrement())
  ticketNumber String       @unique
  title        String
  description  String
  status       TicketStatus @default(OPEN)
  priority     Priority

  createdById  Int
  assignedToId Int?

  createdBy  User  @relation("CreatedTickets", fields: [createdById], references: [id])
  assignedTo User? @relation("AssignedTickets", fields: [assignedToId], references: [id])

  histories   TicketHistory[]
  comments    Comment[]
  attachments Attachment[]
  sprintId    Int?
  sprint      Sprint?         @relation(fields: [sprintId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([assignedToId])
  @@index([createdById])
}

model TicketHistory {
  id       Int     @id @default(autoincrement())
  ticketId Int
  userId   Int
  action   String
  oldValue String?
  newValue String?

  ticket Ticket @relation(fields: [ticketId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([ticketId])
}

model Comment {
  id       Int    @id @default(autoincrement())
  ticketId Int
  userId   Int
  content  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ticket Ticket @relation(fields: [ticketId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([ticketId])
}

model Attachment {
  id       Int @id @default(autoincrement())
  ticketId Int
  userId   Int

  fileName String
  fileType String
  fileSize Int
  fileUrl  String

  createdAt DateTime @default(now())

  ticket Ticket @relation(fields: [ticketId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([ticketId])
}

enum SprintStatus {
  PLANNED
  ACTIVE
  COMPLETED
}

model Sprint {
  id     Int          @id @default(autoincrement())
  name   String
  goal   String?
  status SprintStatus @default(PLANNED)

  startDate DateTime
  endDate   DateTime

  createdById Int
  createdBy   User @relation("SprintCreator", fields: [createdById], references: [id])

  tickets Ticket[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
